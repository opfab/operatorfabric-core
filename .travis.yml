os: linux
dist: xenial
addons:
    sonarcloud:
        organization: "opfab"
        token:
            secure: "r3BfCTuMqW5B6GvQR5ZnnHauciJsqOLeKPMRp7NS1vr6oIo4SHIO6zyLbHUK7ItRt8at+DPkQE8eHtDSWlYutKwfbRPwxcqR4zf4AYuVmHWCS7WmcERMEixbOo5lGQ47KjMMsTbGTSg+Atv80Y3fugX4prm4rDWE8G/Irqvw4GW8P9DeI5upHOTBRzPifrT/PVoovCsqkdfzEFJBYb/fl9VdT340+nrxmcM1Lm1dQeDibAdqdXJQxjgKvbZTUq0D8Ih65EPEESQZjkb8G9CGumsfm6Rhcu1btrqVUCdv8QXe/ERkmryMSA041SmgmtEAf+b/TfdgIn1SLnEbOlLIv1melv0yvBhMHijcASZP1gsnfOTBKFRE616a87L7y3XrX58OAHiAaZ9ecpW5McOI6hHwlHpUaFvKTvbN05lxe3VziYmCIT0SRRrfquyoe8b9s/04FzGTSVnVumKCzlwUJq5M1pbjnS5XOgQCuwauAEarqdCyS9iSWPPm8NkSxkkNu43tCykYRh8dDAN/4E7f8oSoW2RrSsMpJ7a3Q77ACVQJQZtiGQdDStUPHtLNQlN8vzbYNHrkpZbO4nT64tONaTvwFirbkuQpkAGmYFN8jSSeyNRI+gM1lx3fxowjyIt+D+8KsofX5GYG7IDRTt9jVUkcwBOicDG9IuZ3ZaZRtVU="
services:
  - docker
env:
  - NODE_VERSION="v10.16.3"
language: java
# To avoid duplicate builds generated by tags
if: tag IS blank
before_install:
  - export OF_VERSION=$(<VERSION)
  - export GRADLE_OPTS="-XX:MaxMetaspaceSize=512m -Xmx1024m"
  - export SDKMAN_CONFIG_FILE=${HOME}/.sdkman/etc/config
  - ./CICD/travis/check_version.sh --branch $TRAVIS_BRANCH --version $OF_VERSION
  - nvm install $NODE_VERSION
install:
  # first install needs to remove ~/.sdkman (empty in our case because created by cache step) otherwise SdkMan is not installed
  # then install sdkman
  # configures by default SdkMan to use new installed java directly and updates itself if needed.
  - if [ -z "$(ls -A ${HOME}/.sdkman)" ]; then
    rm -fr ${HOME}/.sdkman ;
    curl -s "https://get.sdkman.io" | bash ;
    echo sdkman_auto_answer=true > ${SDKMAN_CONFIG_FILE} ;
    echo sdkman_auto_selfupdate=true >> ${SDKMAN_CONFIG_FILE} ;
    fi
  # needed in order to have sdk available into the current environment
  - source "${HOME}/.sdkman/bin/sdkman-init.sh" ;
  - EXPECTED_NPM_VERSION="6.4.1"
  - CurrentNpmVersion="$(npm -version)"
  - if [ "${CurrentNpmVersion}" != "${EXPECTED_NPM_VERSION}" ] ; then npm i -g npm@${EXPECTED_NPM_VERSION} ; fi
  # Uses JAVA_VERSION file content to be synchronised with ${OF_HOME}/bin/load_environment_light.sh.
  # It's the first part of the sdk reference without vendor name
  # for example the current configured in sdk has the following reference `8.0.272-zulu`
  # the value of the following variable is `8.0.272` and its vendor name part is `-zulu`
  - CURRENT_JDK_VERSION="$(<JAVA_VERSION)"
  # need to substitute last dot by an underscore. Example value for the following: "1.8.0_272"
  # for java version higher than 8 the prefix `1.` should be removed
  - FULL_JDK_VERSION="1.${CURRENT_JDK_VERSION%.*}${CURRENT_JDK_VERSION/*./_}"
  # example value for the following: "8.0.272-zulu"
  - JDK_VERSION_4_SDKMAN="${CURRENT_JDK_VERSION}-zulu"
  # Use javac because the prompt is simpler than the java one
  # skips the beginning should return 1.8.0_272. Here redirection '2>&1' needed to load prompt value otherwise variable is empty
  - CurrentJavacVersionNumber="$(javac -version 2>&1 | cut -d ' ' -f 2)"
  # if javac version is different than expected then asks sdkman to use expected java version or install it if necessary
  # if sdkman can't use the expected java version then asks sdkman to install it. Sdkman is configured to use it as default (line 26)
  - if [ "${CurrentJavacVersionNumber}" != "${FULL_JDK_VERSION}" ] ;
    then
    if ! sdk default java "${JDK_VERSION_4_SDKMAN}" ; then
    sdk install java "${JDK_VERSION_4_SDKMAN}" ;
    fi ;
    fi
  - if [ -s ${SDKMAN_CONFIG_FILE} ]; then
    if [ $(cat ${SDKMAN_CONFIG_FILE} | wc -l) -gt 1 ]; then
    echo sdkman_auto_selfupdate=true > ${SDKMAN_CONFIG_FILE} ;
    fi
    else
    echo sdkman_auto_selfupdate=true > ${SDKMAN_CONFIG_FILE} ;
    fi
  - sudo apt-get install realpath
jobs:
  include:
    - stage: test
      script:
        - docker-compose -f src/main/docker/test-environment/docker-compose.yml up -d
        - ./gradlew --build-cache copyDependencies test
        - docker-compose -f src/main/docker/test-environment/docker-compose.yml down
    - stage: test-sonar
      script:
        - docker-compose -f src/main/docker/test-environment/docker-compose.yml up -d
        - ./gradlew --build-cache copyDependencies test jacocoTestReport
        # [OC-865] Dropping dependency messing with typescript version as a workaround until sonar bug is fixed
        # See https://github.com/SonarSource/SonarJS/issues/1928 and https://community.sonarsource.com/t/error-about-unsupported-ts-version-while-project-is-using-supported-version/15776
        - rm -r ui/main/node_modules/@compodoc/ngd-core
        - rm -r ui/main/node_modules/ts-simple-ast
        # Sonar-scanner need java 11 to run properly [OC-1216]
        # as sdk is used need to install java 11 if not available
        - JDK_VERSION_4_SONAR="11.0.9-zulu"
        - if ! sdk use java "${JDK_VERSION_4_SONAR}" ;
          then
          sdk install java "${JDK_VERSION_4_SONAR}" ;
          fi ;
        - sonar-scanner
        - docker-compose -f src/main/docker/test-environment/docker-compose.yml down
    - stage: doc
      script:
        - ./gradlew --build-cache generateSwaggerUI asciidoctor
        - ./CICD/travis/upload_doc.sh
    - stage: doc-dry-run
      script:
        - ./gradlew --build-cache generateSwaggerUI asciidoctor
    - stage: docker-push-version
      script:
        - echo preparing images for version $OF_VERSION
        - docker login --username ${DOCKER_CLOUD_USER} --password ${DOCKER_CLOUD_PWD}
        - ./gradlew --build-cache copyWorkingDir dockerPush${OF_VERSION} -x test
        - docker image ls -a|grep lfeoperatorfabric
    - stage: docker-push-latest
      script:
        - echo preparing images for version $OF_VERSION
        - docker login --username ${DOCKER_CLOUD_USER} --password ${DOCKER_CLOUD_PWD}
        - ./gradlew --build-cache copyWorkingDir dockerPushLatest -x test
        - docker image ls -a|grep lfeoperatorfabric
    - stage: docker-tag-version
      script:
        - echo preparing images for version $OF_VERSION
        - ./gradlew --build-cache copyWorkingDir dockerTag${OF_VERSION} -x test
        - docker image ls -a|grep lfeoperatorfabric
stages:
  # Note: The condition on type is necessary to exclude PRs because their base branch is usually develop
  - name: test
    if: type = pull_request AND head_repo != opfab/operatorfabric-core
  - name: test-sonar
    if: NOT (type = pull_request AND head_repo != opfab/operatorfabric-core)
  - name: doc
    if: ((((type = cron OR commit_message =~ ci_documentation) AND branch = develop) OR branch = master) AND NOT type = pull_request)
  - name: doc-dry-run
    if: (branch =~ .+release$) OR (NOT (branch IN (master,develop)) AND commit_message =~ ci_documentation)
  - name: docker-push-version
    if: (((type = cron OR commit_message =~ ci_docker) AND branch = develop) OR branch = master) AND NOT type = pull_request
  - name: docker-push-latest
    if: branch = master AND commit_message =~ ci_latest AND NOT type = pull_request
  - name: docker-tag-version
    if: (branch =~ .+release$) OR (NOT (branch IN (master,develop)) AND commit_message =~ ci_docker)
before_cache:
  # cleanup gradle caches
  - rm -f  ${HOME}/.gradle/caches/modules-2/modules-2.lock
  - rm -fr ${HOME}/.gradle/caches/*/plugin-resolution/
cache:
  bundler: true
  directories:
    # caches gradle caches
    - ${HOME}/.gradle/caches/
    - ${HOME}/.gradle/wrapper/
    - ${HOME}/.gradle/dependency-check-data/
    # cache ui dependencies
    - ui/main/nodes_modules
    - ${HOME}/.sdkman
